sudo: required
services:
  - docker
language:
  - c
compiler:
  - gcc
  - clang
os:
  - linux
  - osx
addons:
  apt:
    packages:
    - flex
    - bison
    - gperf
    - pkg-config
    - binutils-mingw-w64-i686
    - gcc-mingw-w64-i686
    - binutils-mingw-w64
    - gcc-mingw-w64
env:
  global:
    - BUILD_BRANCH=$TRAVIS_BRANCH
    - BUILD_ID=$TRAVIS_BUILD_NUMBER
  matrix:
    - BUILD_DEPLOY=1 BUILD_TARGET=linux PACK=none
#    - BUILD_DEPLOY=1 BUILD_TARGET=osx PACK=none
    - BUILD_DEPLOY=1 BUILD_TARGET=win32 PACK=none
    - BUILD_DEPLOY=1 BUILD_TARGET=win64 PACK=none
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=6 PACK=rpm
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=7 PACK=rpm
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=24 PACK=rpm
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=25 PACK=rpm
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=rawhide PACK=rpm
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=trusty PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=precise PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=wily PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=xenial PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=jessie PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=wheezy PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=stretch PACK=deb
    - BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=sid PACK=deb
matrix:
  allow_failures:
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=6 PACK=rpm
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=7 PACK=rpm
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=24 PACK=rpm
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=25 PACK=rpm
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=rawhide PACK=rpm
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=precise PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=trusty PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=wily PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=xenial PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=jessie PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=wheezy PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=stretch PACK=deb
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=sid PACK=deb
  exclude:
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=6 PACK=rpm
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=7 PACK=rpm
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=24 PACK=rpm
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=25 PACK=rpm
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=rawhide PACK=rpm
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=precise PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=trusty PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=wily PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=xenial PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=wheezy PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=jessie PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=stretch PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=sid PACK=deb
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=6 PACK=rpm
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=7 PACK=rpm
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=24 PACK=rpm
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=25 PACK=rpm
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=rawhide PACK=rpm
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=precise PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=trusty PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=wily PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=xenial PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=wheezy PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=jessie PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=stretch PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=sid PACK=deb
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux PACK=none
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=osx PACK=none
      os: linux
    - env: BUILD_DEPLOY=1 BUILD_TARGET=win32 PACK=none
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=win64 PACK=none 
      os: osx
    - env: BUILD_DEPLOY=1 BUILD_TARGET=win32 PACK=none
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=win64 PACK=none
      compiler: clang
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=6 PACK=rpm
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=el DIST=7 PACK=rpm
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=24 PACK=rpm
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=25 PACK=rpm
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=fedora DIST=rawhide PACK=rpm
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=precise PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=trusty PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=wily PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=ubuntu DIST=xenial PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=wheezy PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=jessie PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=stretch PACK=deb
      osx_image: xcode7.1
    - env: BUILD_DEPLOY=1 BUILD_TARGET=linux OS=debian DIST=sid PACK=deb
      osx_image: xcode7.1
before_deploy:
- export BUILD_ARCHIVE=openaaa-$BUILD_MAJOR.$BUILD_MINOR.$BUILD_REVISION-$BUILD_OS_NAME-$BUILD_OS_ARCH-$BUILD_OS_RELEASE.tar.gz
- ./scripts/travis/archive.sh $BUILD_ARCHIVE
before_install:
- source ./scripts/travis/before_install.sh
script:
- git submodule update --init --recursive
- git describe --long --always
- git clone https://github.com/packpack/packpack.git packpack
- make defconfig
- make
- make modules_install
- if [[ $PACK == 'rpm' ]]; then packpack/packpack; fi
deploy:
  # Deploy packages to PackageCloud
  provider: packagecloud
  username: ${PACKAGECLOUD_USER}
  repository: ${PACKAGECLOUD_REPO}
  token: ${PACKAGECLOUD_TOKEN}
  dist: ${OS}/${DIST}
  package_glob: build/*.{deb,rpm}
  skip_cleanup: true
  on:
    branch: master
    condition: -n "${OS}" && -n "${DIST}" && -n "${PACKAGECLOUD_TOKEN}"

notifications:
  on_success: never
  on_failure: never
  email: false
